# Komandara â€” A RISC-V CPU, Vibe-Coded from Spec to Silicon

**Komandara** is an open-source, from-scratch RISC-V CPU design project with a twist: **the RTL is entirely written by AI.** The human stays on the system engineering side â€” defining the architecture, writing the specifications, setting the constraints, and steering the direction â€” while an AI pair-programmer (Claude, via Cursor) produces all the SystemVerilog, testbenches, build scripts, and verification infrastructure.

> **The human does not touch the code.** Every line of RTL, every testbench, every build script in this repository was generated by AI, guided only by natural-language architectural decisions and spec references.

This is an experiment in **vibe coding** applied to hardware design: can a human systems architect, armed with the right specs and a clear vision, produce a working, verified RISC-V core without writing a single line of Verilog?

---

## Current Focus: K10

**K10** is the first-generation core and the current focus of all development.

| Feature | K10 Spec |
|---|---|
| **ISA** | RV32IMAC_Zicsr_Zifencei |
| **Pipeline** | 5-Stage Classic (In-Order): IF â†’ ID â†’ EX â†’ MEM â†’ WB |
| **Privilege Modes** | Machine (M) + User (U) |
| **Memory Model** | Physical Addressing Only (No MMU) |
| **Memory Protection** | PMP (Physical Memory Protection, 16 regions) |
| **Unaligned Access** | Hardware support (LSU splits into 2 aligned bus ops) |
| **Bus Protocol** | AXI4-Lite (SoC interconnect) |
| **Memory** | Parametric BRAM (infers FPGA BRAM, configurable size via FuseSoC) |
| **Target OS** | RTOS (FreeRTOS, Zephyr) or Bare-metal |
| **Coding Standard** | IEEE 1800-2017 SystemVerilog, ASIC-style |

### Reference Specifications

All design logic strictly adheres to the ratified RISC-V specifications:

- **Unprivileged ISA:** `spec/riscv-spec-20191213.txt` (RV32IMAC_Zicsr_Zifencei)
- **Privileged Architecture:** `spec/riscv-privileged-20211203.txt` (M+U modes, PMP)

---

## Roadmap

Komandara is designed as a family of cores with increasing complexity:

| Generation | Key Features | Status |
|---|---|---|
| **K10** | 5-stage in-order, M+U modes, PMP, AXI4-Lite | ðŸ”¨ In Progress |
| **K20** | Sv32 MMU + Supervisor Mode (S) â†’ Linux-capable | ðŸ“‹ Planned |
| **K40** | Dual Core + L1 Cache Coherence (MESI) + Atomics | ðŸ“‹ Planned |
| **K61** | Out-of-Order Execution + Superscalar | ðŸ“‹ Planned |

---

## Repository Structure

```
komandara/
â”œâ”€â”€ rtl/k10/                         # K10 CPU core RTL
â”‚   â”œâ”€â”€ komandara_k10_pkg.sv         # Central package (opcodes, structs, types)
â”‚   â”œâ”€â”€ k10_fetch.sv                 # IF stage â€” PC, alignment buffer
â”‚   â”œâ”€â”€ k10_decode.sv                # ID stage â€” instruction decode, control
â”‚   â”œâ”€â”€ k10_compressed_decoder.sv    # RV32C â†’ RV32I expansion
â”‚   â”œâ”€â”€ k10_execute.sv               # EX stage â€” ALU, branch resolution, forwarding
â”‚   â”œâ”€â”€ k10_alu.sv                   # Arithmetic Logic Unit
â”‚   â”œâ”€â”€ k10_mul_div.sv               # M extension â€” multiply/divide unit
â”‚   â”œâ”€â”€ k10_imm_gen.sv               # Immediate generator
â”‚   â”œâ”€â”€ k10_memory.sv                # MEM stage â€” pipeline wrapper for LSU
â”‚   â”œâ”€â”€ k10_lsu.sv                   # Load/Store Unit (aligned + unaligned + AMO)
â”‚   â”œâ”€â”€ k10_writeback.sv             # WB stage â€” result selection
â”‚   â”œâ”€â”€ k10_regfile.sv               # 32-entry register file
â”‚   â”œâ”€â”€ k10_hazard_unit.sv           # Forwarding, stalls, flushes
â”‚   â”œâ”€â”€ k10_csr.sv                   # M/U mode CSRs, trap handling
â”‚   â”œâ”€â”€ k10_pmp.sv                   # Physical Memory Protection
â”‚   â”œâ”€â”€ k10_tracer.sv                # Instruction tracer (sim only, RISC-DV compatible)
â”‚   â”œâ”€â”€ k10_core.sv                  # Core top â€” instantiates all pipeline stages
â”‚   â”œâ”€â”€ k10_top.sv                   # SoC top â€” core + AXI crossbar + BRAM + periph
â”‚   â”œâ”€â”€ komandara_k10.core           # FuseSoC core file
â”‚   â”œâ”€â”€ periph/                      # Peripherals
â”‚   â”‚   â”œâ”€â”€ k10_timer.sv             # AXI4-Lite Timer (mtime)
â”‚   â”‚   â””â”€â”€ k10_sim_ctrl.sv          # Simulation controller (exit, print)
â”‚   â””â”€â”€ tb/                          # Testbenches
â”‚       â”œâ”€â”€ k10_tb.sv                # Verilator testbench (SoC wrapper)
â”‚       â”œâ”€â”€ k10_tb.cpp               # Verilator C++ driver
â”‚       â”œâ”€â”€ tb_mul_div.sv            # Standalone mul/div testbench
â”‚       â”œâ”€â”€ tb_mul_div.cpp           # Standalone mul/div C++ driver
â”‚       â”œâ”€â”€ komandara.vlt            # Verilator lint waivers
â”‚       â”œâ”€â”€ riscv_core_setting.sv    # RISC-DV core configuration
â”‚       â”œâ”€â”€ testlist.yaml            # RISC-DV test list
â”‚       â””â”€â”€ k10_link.ld              # Linker script
â”œâ”€â”€ ip/                              # Reusable IP modules (generation-agnostic)
â”‚   â”œâ”€â”€ common/                      # Shared primitives
â”‚   â”‚   â””â”€â”€ rtl/
â”‚   â”‚       â”œâ”€â”€ komandara_skid_buffer.sv
â”‚   â”‚       â”œâ”€â”€ komandara_arbiter.sv
â”‚   â”‚       â”œâ”€â”€ komandara_bram.sv
â”‚   â”‚       â”œâ”€â”€ komandara_bus2axi4lite.sv
â”‚   â”‚       â””â”€â”€ komandara_bram_axi4lite.sv
â”‚   â”œâ”€â”€ axi4lite/                    # AXI4-Lite bus IP
â”‚   â”‚   â””â”€â”€ rtl/
â”‚   â”‚       â”œâ”€â”€ komandara_axi4lite_pkg.sv
â”‚   â”‚       â”œâ”€â”€ komandara_axi4lite_master.sv
â”‚   â”‚       â”œâ”€â”€ komandara_axi4lite_slave.sv
â”‚   â”‚       â””â”€â”€ komandara_axi4lite_xbar.sv
â”‚   â””â”€â”€ axi4/                        # AXI4 Full bus IP
â”‚       â””â”€â”€ rtl/
â”‚           â”œâ”€â”€ komandara_axi4_pkg.sv
â”‚           â”œâ”€â”€ komandara_axi4_master.sv
â”‚           â”œâ”€â”€ komandara_axi4_slave.sv
â”‚           â””â”€â”€ komandara_axi4_xbar.sv
â”œâ”€â”€ sw/k10/                          # Software tests
â”‚   â”œâ”€â”€ smoke_test.S                 # Basic arithmetic smoke test
â”‚   â””â”€â”€ unaligned_test.S             # Self-checking unaligned memory access test
â”œâ”€â”€ scripts/                         # Build & verification scripts
â”‚   â”œâ”€â”€ setup_tools.sh               # One-time tool installation
â”‚   â”œâ”€â”€ env.sh                       # Environment setup (portable)
â”‚   â”œâ”€â”€ run_riscv_dv.sh              # RISC-DV verification flow (with Spike comparison)
â”‚   â”œâ”€â”€ run_selfcheck_test.sh        # Self-checking test runner (no Spike)
â”‚   â””â”€â”€ verilog_byte2word.py         # Hex file converter
â”œâ”€â”€ spec/                            # RISC-V specification documents
â”œâ”€â”€ tools/                           # Installed tools (gitignored)
â””â”€â”€ build/                           # Build artifacts (gitignored)
```

---

## Verification Status

### K10 Core

| Test | Method | Status |
|---|---|---|
| **Smoke Test** (basic arithmetic) | Spike trace comparison | âœ… Pass |
| **RISC-DV Arithmetic** (`riscv_arithmetic_basic_test`) | Spike trace comparison (random, 200 instr) | âœ… Pass |
| **Unaligned Memory Access** (19 tests) | Self-checking (LW/LH/LHU/SW/SH at offset +1,+2,+3) | âœ… Pass |
| **Multiply/Divide** (standalone) | Self-checking (MUL/MULH/DIV/REM/DIVU/REMU, div-by-zero, overflow) | âœ… Pass |
| **C Self-Test Suite** (`sw/k10/tests`) | Self-checking (Arithmetic, Unaligned, IRQ, Traps) | âœ… Pass |
| **RISC-DV Regression** (13 tests) | Spike trace comparison (Auto-generated assembly) | â³ integrated (Available) |
| **RISC-DV Load/Store** (`riscv_unaligned_load_store_test`) | Spike trace comparison | ðŸ“‹ Pending |
| **CSR Test** (`riscv_csr_test`) | Spike trace comparison | ðŸ“‹ Pending |
| **Branch/Jump Stress** | Spike trace comparison | ðŸ“‹ Pending |
| **PMP Test** | Directed test | ðŸ“‹ Pending |
| **Interrupt Test** | Directed test | ðŸ“‹ Pending |

### Bus Infrastructure

All bus modules verified using **Xilinx AXI Verification IP (VIP)** with 0 failures:

- **AXI4-Lite:** Master, Slave, Parametric Crossbar (NÃ—M)
- **AXI4 Full:** Master, Slave, Parametric Crossbar (NÃ—M)
- **Skid Buffers:** Full-throughput, zero-bubble operation
- **Arbiter:** Round-robin and fixed-priority policies

---

## K10 Microarchitecture

```
+--------------------------------------------------------------------------------+
|                                   k10_core                                     |
|                                                                                |
|  +--------+   +--------+   +---------+   +--------+   +-----------+            |
|  | FETCH  |-->| DECODE |-->| EXECUTE |-->| MEMORY |-->| WRITEBACK |            |
|  |k10_    |   |k10_    |   |k10_     |   |k10_    |   |k10_       |            |
|  |fetch   |   |decode  |   |execute  |   |memory  |   |writeback  |            |
|  +---+----+   +---+----+   +----+----+   +---+----+   +-----------+            |
|      |            |             |            |                                 |
|      |   decode side blocks     |            |                                 |
|      |   - compressed decoder   |            |                                 |
|      |   - regfile              |            |                                 |
|      |                          |            |                                 |
|      |              execute side blocks      memory side blocks                |
|      |              - ALU                    - LSU (unaligned split)           |
|      |              - IMM generator          - PMP checks                      |
|      |              - MUL/DIV                                                  |
|      |              - CSR path                                                 |
|      |                                                                         |
|      +------------------ HAZARD UNIT (forwarding/stall/flush) --------------+  |
+--------------------------------------------------------------------------------+
                 | ibus                                   | dbus
                 v                                        v
            +------------+                          +------------+
            | bus2axi4   |                          | bus2axi4   |
            | lite       |                          | lite       |
            +-----+------+                          +-----+------+
                  |                                         |
                  +----------------+   +--------------------+
                                   |   |
                          +--------+---+--------+
                          | AXI4-Lite XBAR (2x2)|
                          +--------+---+--------+
                                   |   |
                           +-------+   +---------+
                           | BRAM  |   | Periph  |
                           |64KB d.|   | Port    |
                           +-------+   +---------+
```

### Key Design Decisions

- **Unaligned Access:** The LSU transparently splits unaligned word/halfword accesses into two consecutive aligned bus operations. No trap handler needed.
- **Multiply:** Single-cycle combinational (synthesis tool handles timing).
- **Divide:** Iterative restoring division (33 cycles). FSM holds result until pipeline consumes it.
- **Forwarding:** Full MEMâ†’EX and WBâ†’EX forwarding, including to MUL/DIV operands and CSR write data.
- **Compressed Instructions:** RV32C instructions expanded to RV32I equivalents in the decode stage.
- **Memory:** BRAM module designed to infer FPGA BRAM. Size configurable via FuseSoC parameter `MEM_SIZE_KB`.

---

## Design Philosophy

### Vibe Coding

This project follows a strict division of labor:

- **Human (System Architect):** Defines the ISA target, pipeline architecture, bus topology, memory map, privilege model, and verification strategy. Writes the rules and constraints. Reviews simulation results. Makes architectural decisions.
- **AI (RTL Engineer):** Implements all SystemVerilog modules, testbenches, scripts, and FuseSoC core files. Debugs simulation failures. Iterates until verification passes.

The human intervenes in the code as little as possible â€” ideally, **not at all.** The goal is to explore how far AI-assisted hardware design can go when the human focuses purely on architecture and specification.

### RTL Coding Standards

- **ASIC-style:** No FPGA primitives, no `initial` blocks, portable across toolchains
- **Two-segment style** (Pong Chu): Strict separation of combinational (`always_comb`) and sequential (`always_ff`) logic
- **`logic` everywhere:** No `wire` or `reg` â€” only `logic`
- **Parametric design:** All infrastructure modules are generic and reusable
- **Async active-low reset:** `always_ff @(posedge i_clk or negedge i_rst_n)`

---

## Prerequisites

### System Packages (Ubuntu 22.04+)

```bash
sudo apt-get install -y \
    git make autoconf g++ flex bison ccache \
    libfl-dev libfl2 zlib1g-dev \
    device-tree-compiler libboost-all-dev \
    perl python3 python3-venv \
    numactl curl help2man cmake
```

### Optional (for AXI VIP verification)

- **Vivado 2023.2+** â€” Required only for Xilinx AXI VIP testbenches

---

## Getting Started

### One-Time Setup

```bash
# 1. Create and activate Python virtual environment
python3 -m venv .venv
source .venv/bin/activate

# 2. Run the tool setup script (builds Verilator, Spike, downloads toolchain, etc.)
./scripts/setup_tools.sh

# 3. Load the environment
source scripts/env.sh
```

### Daily Workflow

```bash
# Activate venv and load tool paths
source .venv/bin/activate
source scripts/env.sh

# Now you can use: verilator, spike, riscv32-unknown-elf-gcc, fusesoc
```

### What `setup_tools.sh` Installs

All tools are installed **locally** into the `tools/` directory (gitignored):

| Tool | Purpose | Location |
|---|---|---|
| **Verilator** (v5.028) | RTL simulation & linting | `tools/verilator/` |
| **Spike** | RISC-V ISA golden reference model | `tools/spike/` |
| **RISC-V GNU Toolchain** | Cross-compiler (`riscv32-unknown-elf-gcc`) | `tools/riscv-toolchain/` |
| **RISC-V DV** | Random instruction generator | `tools/riscv-dv/` |
| **FuseSoC** | Build system (via pip) | `.venv/` |

---

## Running Tests

### Smoke Test (Spike Comparison)

```bash
./scripts/run_riscv_dv.sh --asm sw/k10/smoke_test.S
```

### RISC-DV Random Arithmetic Test

```bash
./scripts/run_riscv_dv.sh --test riscv_arithmetic_basic_test --seed 42
```

### Unaligned Memory Access Test (Self-Checking)

```bash
./scripts/run_selfcheck_test.sh sw/k10/unaligned_test.S
```

### Standalone Mul/Div Test

```bash
# Build and run from rtl/k10/tb/
fusesoc --cores-root=. run --target=sim --build komandara:core:k10
```

---

## Build System

The project uses **FuseSoC** (CAPI2) for dependency management and build orchestration.

Core files follow the naming convention: `komandara:<lib>:<name>:<version>`

### FuseSoC Parameters

| Parameter | Default | Description |
|---|---|---|
| `MEM_SIZE_KB` | 64 | BRAM size in kilobytes (must be power of 2) |
| `BOOT_ADDR` | 0 | Initial program counter value |
| `MEM_INIT` | "" | Path to hex file for BRAM initialisation |

---

## License

Licensed under the [Apache License, Version 2.0](LICENSE).

```
Copyright 2025 The Komandara Authors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```

---

## Acknowledgments

- **RISC-V Foundation** for the open ISA specifications
- **Xilinx/AMD** for the AXI Verification IP used in bus module verification
- **Cursor + Claude** for making vibe-coded hardware design possible
